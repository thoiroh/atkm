<div class="terminal-wrapper">
  <header class="terminal-header">
    @if (currentConfig(); as config) {
    <h1>{{ config.title }}</h1>
    <div class="terminal-details">
      <h2>{{ config.subtitle }}</h2>
    </div>
    }
  </header>

  <main class="terminal-main">
    <!-- Terminal Section -->
    <div class="terminal-section">
      <div class="terminal-content">
        <!-- <atk-icon class="terminal-toggle" name="triangle-right" color="var(--color-btn-bg-default)" /> -->

        <!-- Terminal Status Bar -->
        <div class="terminal-status">
          <span>Ln {{ line() }},</span>
          <span>Col {{ column() }} · Idx {{ caretIndex() }}</span>
          @if (selectionText(); as text) {
          <span class="input-selection"> · Sel "{{ text }}"</span>
          }
        </div>

        <textarea #terminalTextarea class="terminal-input" [value]="terminalText()"
          [style.--input-min-height]="currentConfig()?.terminal.height || '500px'" spellcheck="false" autocorrect="off"
          autocomplete="off" autocapitalize="off" placeholder="">
        </textarea>
      </div>

      <!-- Terminal Command Panel -->
      @if (currentConfig()?.terminal.showControls !== false) {
      <div class="terminal-cmd">
        <!-- Endpoint Selection -->
        @if (currentConfig(); as config) {
        @if (config.endpoints.length > 1) {
        <div class="cmd-item">
          <label>API Endpoint</label>
          <select class="cmd-select" [value]="currentEndpoint()" (change)="onEndpointChange($event)">
            @for (endpoint of config.endpoints; track endpoint.id) {
            <option [value]="endpoint.id">{{ endpoint.name }}</option>
            }
          </select>
        </div>
        }}

        <!-- Current Parameters Display -->
        @if (terminalState().requestParams; as params) {
        @if ((params | keyvalue).length > 0) {
        <div class="cmd-item">
          <label>Parameters</label>
          <div class="cmd-params">
            @for (param of params | keyvalue; track param.key) {
            <div class="param-item">
              <span class="param-key">{{ param.key }}:</span>
              <span class="param-value">{{ param.value }}</span>
            </div>
            }
          </div>
        </div>
        }
        }

        <!-- Action Buttons -->
        <!-- <button class="cmd-btn" (click)="testConnection()" [disabled]="terminalState().loading">
          <atk-icon name="wifi" />
          {{ terminalState().loading ? 'Testing...' : 'Test Connection' }}
        </button> -->

        <button class="cmd-btn" (click)="loadData()" [disabled]="terminalState().loading || !currentEndpoint()">
          <div class="cmd-btn-icon" style="color: #8b5cf6;">
            <atk-icon name="database" />
          </div>
          {{ terminalState().loading ? 'Loading...' : 'Load Data' }}
        </button>

        <!-- Quick Symbol Input for Trades/Orders -->
        @if (currentEndpoint() === 'trades' || currentEndpoint() === 'orders') {
        <div class="cmd-item">
          <label>Trading Symbol</label>
          <input type="text" class="cmd-input" placeholder="BTCUSDT" #symbolInput
            (keyup.enter)="loadData({ symbol: symbolInput.value.toUpperCase() })" value="BTCUSDT">
          <button class="cmd-btn-small" (click)="loadData({ symbol: symbolInput.value.toUpperCase() })"
            [disabled]="terminalState().loading">
            Load
          </button>
        </div>
        }

        <!-- Custom Actions from Config -->
        @if (currentConfig()?.actions; as actions) {
        @for (action of actions; track action.id) {
        <button class="cmd-btn" [class]="'cmd-btn-' + (action.variant || 'secondary')" (click)="action.handler()"
          [disabled]="action.disabled || action.loading">
          @if (action.icon) {
          <div class="cmd-btn-icon">
            <atk-icon [name]="action.icon" />
          </div>
          }
          {{ action.loading ? 'Processing...' : action.label }}
        </button>
        }
        }

        <!-- Terminal Command Input -->
        <!-- <div class="cmd-item">
          <label>Terminal Commands</label>
          <input type="text" class="cmd-input" placeholder="Type 'help' for commands..." #commandInput
            (keyup.enter)="executeCommand(commandInput.value); commandInput.value = ''">
          <button class="cmd-btn" (click)="executeCommand(commandInput.value); commandInput.value = ''">
            Run
          </button>
        </div> -->
      </div>
      }
    </div>

    <!-- Data Table Section -->
    @if (data().length > 0 && visibleColumns().length > 0) {
    <div class="terminal-section">
      <div class="bash-content">
        <atk-icon class="bash-toggle" name="triangle-right" color="var(--color-btn-bg-default)" />

        <div class="bash-table-header">
          <div class="bash-table-title">
            <h2>{{ getCurrentEndpointName() || 'Data Results' }}</h2>
            <div class="table-meta">
              <span class="data-count">{{ data().length }} items</span>
              @if (terminalState().responseMetadata?.responseTime) {
              <span class="response-time">{{ terminalState().responseMetadata.responseTime }}ms</span>
              }
            </div>
          </div>
        </div>

        <!-- Enhanced Data Table -->
        <div class="bash-table">
          <!-- Table Header -->
          <div class="table-header-row">
            @for (column of visibleColumns(); track column.key) {
            <div class="table-header-cell" [style.width]="column.width" [class]="'align-' + (column.align || 'left')">
              {{ column.label }}
              @if (column.sortable) {
              <atk-icon name="chevron-up-down" [size]="12" color="var(--color-fg-muted)" />
              }
            </div>
            }
          </div>

          <!-- Table Rows -->
          @for (row of data(); track trackByIndex($index, row)) {
          <div class="table-row">
            @for (column of visibleColumns(); track column.key) {
            <div class="table-cell" [style.width]="column.width" [class]="'align-' + (column.align || 'left')"
              [ngClass]="column.cssClass">

              @if (column.template) {
              <!-- Custom template -->
              <ng-container [ngTemplateOutlet]="column.template"
                [ngTemplateOutletContext]="{ $implicit: row[column.key], row: row, column: column }">
              </ng-container>
              } @else {
              <!-- Enhanced formatting with pipes -->
              @switch (column.type) {
              @case ('custom') {
              <span class="cell-content">
                {{ formatCellValue(row[column.key], column) }}
              </span>
              }
              @case ('badge') {
              @if (column.key === 'side') {
              <span class="badge" [ngClass]="(row[column.key] | statusBadge:'trade-side').cssClass">
                {{ (row[column.key] | statusBadge:'trade-side').text }}
              </span>
              } @else if (column.key === 'status') {
              <span class="badge" [ngClass]="(row[column.key] | statusBadge:'order-status').cssClass">
                {{ (row[column.key] | statusBadge:'order-status').text }}
              </span>
              } @else {
              <span class="badge badge-default">
                {{ row[column.key] | uppercase }}
              </span>
              }
              }
              @case ('date') {
              <span class="cell-content date-cell">
                {{ row[column.key] | timestampToDate }}
              </span>
              }
              @case ('currency') {
              <span class="cell-content currency-cell">
                {{ row[column.key] | currency:'EUR':'symbol':'1.2-2' }}
              </span>
              }
              @case ('percentage') {
              <span class="cell-content percentage-cell"
                [ngClass]="row[column.key] > 0 ? 'text-success' : row[column.key] < 0 ? 'text-danger' : 'text-muted'">
                {{ row[column.key] | number:'1.2-2' }}%
              </span>
              }
              @case ('boolean') {
              <span class="cell-content boolean-cell">
                {{ row[column.key] ? '✅' : '❌' }}
              </span>
              }
              @default {
              <span class="cell-content">
                @if (column.key === 'free' || column.key === 'locked' || column.key === 'total') {
                {{ row[column.key] | balanceFormat }}
                } @else if (column.key === 'price' || column.key === 'qty' || column.key === 'quoteQty') {
                {{ row[column.key] | cryptoPrecision:(column.key === 'qty' ? 'quantity' : 'price') }}
                } @else if (column.key === 'commission') {
                {{ row[column.key] | cryptoPrecision:'fee' }}
                } @else {
                {{ row[column.key] }}
                }
              </span>
              }
              }
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Empty State -->
    @if (data().length === 0 && !terminalState().loading && !error()) {
    @if (currentConfig()?.table.showEmptyState !== false) {
    <div class="bash-section">
      <div class="empty-state">
        <atk-icon name="database" color="var(--color-fg-muted)" [size]="48" />
        <h3>No Data Available</h3>
        <p>Click "Load Data" to fetch information from the {{ currentEndpoint() }} endpoint.</p>
        @if (currentEndpoint() === 'trades' || currentEndpoint() === 'orders') {
        <p class="empty-hint">
          <strong>Tip:</strong> Enter a trading symbol (e.g., BTCUSDT) in the symbol field above.
        </p>
        }
      </div>
    </div>
    }
    }

    <!-- Error State -->
    @if (error()) {
    <div class="bash-section">
      <div class="error-state">
        <atk-icon name="alert-circle" color="#ef4444" [size]="24" />
        <h3>Error Loading Data</h3>
        <p class="error-message">{{ error() }}</p>
        <div class="error-actions">
          <button class="cmd-btn retry-btn" (click)="loadData()">
            <atk-icon name="refresh-cw" />
            Retry
          </button>
          <button class="cmd-btn" (click)="testConnection()">
            <atk-icon name="wifi" />
            Test Connection
          </button>
        </div>
      </div>
    </div>
    }

    <!-- Loading State -->
    @if (terminalState().loading) {
    <div class="bash-section">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading data from <strong>{{ currentEndpoint() }}</strong> endpoint...</p>
        @if (terminalState().requestParams?.symbol) {
        <p class="loading-detail">Symbol: {{ terminalState().requestParams.symbol }}</p>
        }
      </div>
    </div>
    }
  </main>
</div>
