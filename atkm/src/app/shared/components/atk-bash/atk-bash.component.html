<!-- atk-bash.component.v03.html -->
<!-- ======================================================
     FULL SIGNALS VERSION
     Compatible avec AtkBashService.v03 et AtkBashComponent.v03
     ====================================================== -->

<div class="bash-wrapper">
  @let sidebarState = sidebarConfigService.state();

  <!-- Header -->
  <header class="bash-header">
    @if (currentConfig(); as config) {
    <h1>Bash</h1>
    <!-- <h1>{{ config.title }}</h1> -->
    <!-- <div class="bash-details">
      @if (lastLog(); as log) {
      <span class="message">{{ log.message }}</span>
      }
    </div> -->
    }
  </header>

  <main class="bash-main">

    <!-- ======================= -->
    <!-- TERMINAL OUTPUT SECTION -->
    <!-- ======================= -->
    <section class="bash-section">
      <div class="bash-content">

        <textarea class="bash-input" atkTerminalInput autocorrect="off" spellcheck="false"
          (stateChange)="onTerminalStateChange($event)" [style.height]="terminalHeight()"></textarea>
        <!-- spellcheck="false" -->
        <!-- autocorrect="off" -->
        <!-- autocomplete="off" -->
        <!-- autocapitalize="off" -->
        <!-- [autoScroll]="true" -->
        <!-- [maxHeight]="'200px'" -->
        <!-- ou [smoothScroll]="true" -->
        <!-- (scrollChange)="onTerminalScroll($event)" -->
        <!-- [autoResize]="true" -->
        <!-- readonly -->

        <!-- Terminal Status -->
        <div class="bash-status">
          <span>Ln {{ line() }}</span>
          <span>Col {{ column() }}</span>
          <span>Idx {{ caretIndex() }}</span>
          @if (selectionText(); as text) {
          <span class="bash-selection">Sel "{{ text }}"</span>
          }
          <span class="bash-connection" [class]="'status-' + sidebarState.connectionStatus">
            {{ sidebarState.connectionStatus | titlecase }}
          </span>
          @if (bashService.loading()) {
          <span class="bash-loading">Loading...</span>
          }
        </div>
      </div>
    </section>

    <!-- <button (click)="testLoadData()">ðŸ§ª Test Load Account Data</button> -->

    <!-- ======================= -->
    <!-- TABLE SECTION -->
    <!-- ======================= -->
    @if (data().length > 0 && visibleColumns().length > 0) {
    <section class="bash-data-section">
      <div class="bash-data-content">
        <span class="bash-data-label">current endpoint</span>
        <header class="bash-data-header">
          <h1>{{ getCurrentEndpointName(sidebarState.currentEndpoint) || 'Data Results' }}</h1>
          <div class="bash-data-meta">
            <span>records: {{ data().length }} items</span>
            @if (terminalState().responseMetadata?.responseTime) {
            <span>-</span>
            <span>responseTime: {{ terminalState().responseMetadata.responseTime }}ms</span>
            }
          </div>
        </header>

        <!-- Datatable Component -->
        <atk-datatable [columns]="visibleColumns()" [data]="data()" [loading]="bashService.loading()" [error]="error()"
          (selectedRow)="onRowSelected($event)" />
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- EMPTY STATE -->
    <!-- ======================= -->
    @if (data().length === 0 && !bashService.loading() && !error()) {
    <section class="bash-section">
      <div class="empty-state">
        <atk-icon name="database" color="var(--color-fg-muted)" [size]="48" />
        <h3>No Data Available</h3>
        <p>Select an endpoint in the sidebar to load data.</p>
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- ERROR STATE -->
    <!-- ======================= -->
    @if (error()) {
    <section class="bash-section">
      <div class="error-state">
        <atk-icon name="alert-circle" color="#ef4444" [size]="24" />
        <h3>Error Loading Data</h3>
        <p class="error-message">{{ error() }}</p>
        <div class="error-actions">
          <button class="cmd-btn retry-btn" (click)="loadData()">
            <atk-icon name="refresh-cw" />
            Retry
          </button>
          <button class="cmd-btn" (click)="testConnection()">
            <atk-icon name="wifi" />
            Test Connection
          </button>
        </div>
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- LOADING STATE -->
    <!-- ======================= -->
    @if (bashService.loading()) {
    <section class="bash-section">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading <strong>{{ sidebarState.currentEndpoint }}</strong>...</p>
        @if (sidebarState.parameters?.symbol) {
        <p class="loading-detail">Symbol: {{ sidebarState.parameters.symbol }}</p>
        }
      </div>
    </section>
    }
  </main>
</div>
