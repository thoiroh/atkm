<!-- atk-bash.component.v03.html -->
<!-- ======================================================
     FULL SIGNALS VERSION
     Compatible avec AtkBashService.v03 et AtkBashComponent.v03
     ====================================================== -->

<div class="bash-wrapper">
  @let sidebarState = sidebarConfigService.state();

  <!-- Header -->
  <header class="bash-header">
    @if (currentConfig(); as config) {
    <h1>{{ config.title }}</h1>
    <div class="bash-details">
      <h2>{{ config.subtitle }}</h2>
    </div>
    }
  </header>

  <main class="bash-main">

    <!-- ======================= -->
    <!-- TERMINAL OUTPUT SECTION -->
    <!-- ======================= -->
    <section class="bash-section">
      <div class="bash-content">

        <textarea class="bash-input" atkTerminalInput [value]="terminalText()"
          [style.--input-min-height]="currentConfig()?.terminal.height || '600px'" [smoothScroll]="true"
          [maxHeight]="currentConfig()?.terminal.height || '400px'" spellcheck="false" autocorrect="off"
          autocomplete="off" autocapitalize="off" (stateChange)="onTerminalStateChange($event)">
        </textarea>

        <!-- readonly -->

        <!-- Terminal Status -->
        <div class="bash-status">
          <span>Ln {{ line() }}</span>
          <span>Col {{ column() }} · Idx {{ caretIndex() }}</span>
          @if (selectionText(); as text) {
          <span class="bash-selection"> · Sel "{{ text }}"</span>
          }
          <span class="bash-connection" [class]="'status-' + sidebarState.connectionStatus">
            {{ sidebarState.connectionStatus | titlecase }}
          </span>
          @if (bashService.loading()) {
          <span class="bash-loading">Loading...</span>
          }
        </div>
      </div>
    </section>

    <!-- ======================= -->
    <!-- TABLE SECTION -->
    <!-- ======================= -->
    @if (data().length > 0 && visibleColumns().length > 0) {
    <section class="bash-section data-section">
      <div class="bash-content">
        <div class="bash-table-header">
          <h2>{{ getCurrentEndpointName(sidebarState.currentEndpoint) || 'Data Results' }}</h2>
          <div class="table-meta">
            <span>{{ data().length }} items</span>
            @if (terminalState().responseMetadata?.responseTime) {
            <span>{{ terminalState().responseMetadata.responseTime }}ms</span>
            }
          </div>
        </div>

        <!-- Table -->
        <div class="bash-table">
          <div class="table-header-row">
            @for (col of visibleColumns(); track col.key) {
            <div class="table-header-cell" [style.width]="col.width" [class]="'align-' + (col.align || 'left')">
              {{ col.label }}
            </div>
            }
          </div>

          @for (row of data(); track trackByIndex($index, row)) {
          <div class="table-row">
            @for (col of visibleColumns(); track col.key) {
            <div class="table-cell" [style.width]="col.width" [class]="'align-' + (col.align || 'left')">
              {{ formatCellValue(row[col.key], col) }}
            </div>
            }
          </div>
          }
        </div>
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- EMPTY STATE -->
    <!-- ======================= -->
    @if (data().length === 0 && !bashService.loading() && !error()) {
    <section class="bash-section">
      <div class="empty-state">
        <atk-icon name="database" color="var(--color-fg-muted)" [size]="48" />
        <h3>No Data Available</h3>
        <p>Select an endpoint in the sidebar to load data.</p>
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- ERROR STATE -->
    <!-- ======================= -->
    @if (error()) {
    <section class="bash-section">
      <div class="error-state">
        <atk-icon name="alert-circle" color="#ef4444" [size]="24" />
        <h3>Error Loading Data</h3>
        <p class="error-message">{{ error() }}</p>
        <div class="error-actions">
          <button class="cmd-btn retry-btn" (click)="loadData()">
            <atk-icon name="refresh-cw" />
            Retry
          </button>
          <button class="cmd-btn" (click)="testConnection()">
            <atk-icon name="wifi" />
            Test Connection
          </button>
        </div>
      </div>
    </section>
    }

    <!-- ======================= -->
    <!-- LOADING STATE -->
    <!-- ======================= -->
    @if (bashService.loading()) {
    <section class="bash-section">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading <strong>{{ sidebarState.currentEndpoint }}</strong>...</p>
        @if (sidebarState.parameters?.symbol) {
        <p class="loading-detail">Symbol: {{ sidebarState.parameters.symbol }}</p>
        }
      </div>
    </section>
    }
  </main>
</div>
